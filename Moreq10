<!--
    Autoría del Código Fuente:
    - Autor Original: [Jhon Gonzalez / Grupo IB Consulting]
    - Fecha de Optimización: Junio de 2025
    - Propósito: Validación y optimización del dashboard MOREQ10 para la conformación de expedientes colombianos.
-->
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard MOREQ10 - Conformación de Expedientes Colombianos</title>
    <style>
        /* Estilos generales y variables CSS */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --info-color: #17a2b8;
            --light-bg: #f8f9fa;
            --white: #ffffff;
            --shadow: 0 2px 10px rgba(0,0,0,0.1);
            --border-radius: 8px;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-bg);
            color: var(--primary-color);
            line-height: 1.6;
        }

        .dashboard-container {
            display: grid;
            grid-template-rows: auto auto 1fr;
            grid-template-areas:
                "header"
                "controls"
                "main";
            height: 100vh;
            overflow: hidden;
        }

        .dashboard-header {
            grid-area: header;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: var(--white);
            padding: 1.5rem;
            text-align: center;
            box-shadow: var(--shadow);
        }

        .dashboard-header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .dashboard-header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .stats-bar {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .stat-item {
            background: rgba(255,255,255,0.1);
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius);
            text-align: center;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .dashboard-controls {
            grid-area: controls;
            background: var(--white);
            padding: 1rem;
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--shadow);
            border-bottom: 1px solid #e0e0e0;
            overflow-x: auto;
        }

        .control-row {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
            width: 100%;
            justify-content: space-between;
        }

        .control-group {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            min-width: 200px;
        }

        .control-group label {
            font-weight: 600;
            color: var(--primary-color);
            white-space: nowrap;
        }

        input, select {
            padding: 0.5rem;
            border: 2px solid #e0e0e0;
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: border-color 0.3s ease;
            min-width: 120px;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--secondary-color);
        }

        .search-input {
            min-width: 250px;
        }

        .export-group {
            display: flex;
            gap: 0.5rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            white-space: nowrap;
        }

        .btn-primary {
            background: var(--secondary-color);
            color: var(--white);
        }

        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .btn-success {
            background: var(--success-color);
            color: var(--white);
        }

        .btn-success:hover {
            background: #219a52;
            transform: translateY(-2px);
        }

        .kanban-container {
            grid-area: main;
            display: flex;
            overflow-x: auto;
            overflow-y: hidden;
            padding: 1rem;
            gap: 1rem;
            height: 100%;
        }

        .kanban-column {
            flex: 0 0 350px;
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            max-height: 100%;
        }

        .kanban-column-header {
            padding: 1rem;
            background: linear-gradient(135deg, #6c757d, #495057);
            color: var(--white);
            font-weight: 700;
            font-size: 1.1rem;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            text-align: center;
            position: relative;
        }

        .column-count {
            position: absolute;
            top: 0.5rem;
            right: 1rem;
            background: rgba(255,255,255,0.2);
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.8rem;
        }

        .kanban-column-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .kanban-item {
            background: var(--white);
            border: 1px solid #e0e0e0;
            border-left: 4px solid var(--secondary-color);
            border-radius: var(--border-radius);
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .kanban-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }

        .item-id {
            font-size: 0.8rem;
            color: #6c757d;
            font-weight: 600;
        }

        .item-title {
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
            line-height: 1.4;
            font-size: 0.9rem;
        }

        .item-description {
            font-size: 0.8rem;
            color: #6c757d;
            margin-bottom: 0.75rem;
            line-height: 1.4;
            max-height: 2.4em;
            overflow: hidden;
            position: relative;
        }

        .item-metadata {
            display: flex;
            flex-wrap: wrap;
            gap: 0.3rem;
            margin-bottom: 0.75rem;
        }

        .metadata-tag {
            padding: 0.1rem 0.4rem;
            border-radius: 8px;
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .expediente-tag {
            background: #17a2b8;
            color: white;
            padding: 0.1rem 0.3rem;
            border-radius: 4px;
            font-size: 0.6rem;
            font-weight: 600;
        }

        .item-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .iso-badges {
            display: flex;
            gap: 0.25rem;
            flex-wrap: wrap;
        }

        .iso-badge {
            padding: 0.1rem 0.3rem;
            background: var(--info-color);
            color: var(--white);
            border-radius: 3px;
            font-size: 0.6rem;
            font-weight: 600;
        }

        .service-badge {
            padding: 0.1rem 0.4rem;
            background: #6c757d;
            color: white;
            border-radius: 3px;
            font-size: 0.6rem;
            font-weight: 600;
        }

        /* Niveles de Criticidad */
        .criticidad-1 { border-left-color: #8B0000; }
        .criticidad-2 { border-left-color: #DC143C; }
        .criticidad-3 { border-left-color: #FF6347; }
        .criticidad-4 { border-left-color: #FF8C00; }
        .criticidad-5 { border-left-color: #FFD700; }
        .criticidad-6 { border-left-color: #ADFF2F; }
        .criticidad-7 { border-left-color: #32CD32; }
        .criticidad-8 { border-left-color: #228B22; }

        .tag-cumplimiento { background: #8B0000; color: white; }
        .tag-riesgo { background: #DC143C; color: white; }
        .tag-dependencia { background: #FF6347; color: white; }
        .tag-sensibilidad { background: #FF8C00; color: white; }
        .tag-frecuencia { background: #FFD700; color: black; }
        .tag-continuidad { background: #ADFF2F; color: black; }
        .tag-conservacion { background: #32CD32; color: white; }
        .tag-recuperacion { background: #228B22; color: white; }

        /* Criticidad Expedientes */
        .crit-exp-alto { background: #dc3545; color: white; }
        .crit-exp-medio { background: #fd7e14; color: white; }
        .crit-exp-bajo { background: #198754; color: white; }

        /* Estilos del Modal de Salvedad */
        .salvedad-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(220, 53, 69, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 1rem;
        }

        .salvedad-content {
            background: white;
            border-radius: var(--border-radius);
            padding: 2rem;
            max-width: 600px;
            width: 100%;
            border: 3px solid #dc3545;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .salvedad-header {
            text-align: center;
            margin-bottom: 1.5rem;
            color: #dc3545;
        }

        .salvedad-header h2 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .salvedad-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .salvedad-body {
            background: #fff3cd;
            padding: 1.5rem;
            border-radius: var(--border-radius);
            margin-bottom: 1.5rem;
            border-left: 4px solid #ffc107;
        }

        .salvedad-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .btn-warning {
            background: #ffc107;
            color: #000;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--border-radius);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-warning:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--border-radius);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-danger:hover {
            background: #c82333;
            transform: translateY(-2px);
        }

        /* Estilos del Modal de Detalles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 1rem;
        }

        .modal-content {
            background: white;
            border-radius: var(--border-radius);
            padding: 2rem;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            width: 100%;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e0e0e0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: #6c757d;
        }

        .modal-close:hover {
            color: var(--danger-color);
        }

        /* Resumen de Filtros */
        .filter-summary {
            background: #e3f2fd;
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius);
            margin: 0.5rem 0;
            font-size: 0.9rem;
            display: none;
        }

        .filter-summary.active {
            display: block;
        }

        /* Carga */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            font-size: 1.2rem;
            color: var(--secondary-color);
        }

        /* Diseño Responsivo */
        @media (max-width: 1400px) {
            .control-row {
                flex-direction: column;
                align-items: stretch;
            }

            .control-group {
                min-width: auto;
                justify-content: space-between;
            }
        }

        @media (max-width: 1200px) {
            .kanban-column {
                flex: 0 0 300px;
            }
        }

        @media (max-width: 768px) {
            .dashboard-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .control-group {
                justify-content: space-between;
            }

            .kanban-container {
                flex-direction: column;
                overflow-x: hidden;
                overflow-y: auto;
            }

            .kanban-column {
                flex: none;
                width: 100%;
                max-height: 500px;
            }

            .stats-bar {
                gap: 1rem;
            }

            .stat-item {
                font-size: 0.9rem;
            }
        }

        /* Estilos de Impresión */
        @media print {
            .dashboard-controls {
                display: none;
            }

            .kanban-container {
                display: block;
                overflow: visible;
            }

            .kanban-column {
                break-inside: avoid;
                margin-bottom: 2rem;
                max-height: none;
            }

            .kanban-item {
                break-inside: avoid;
                margin-bottom: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <header class="dashboard-header">
            <h1>Dashboard MOREQ10 - Conformación de Expedientes Colombianos</h1>
            <p>174 Requisitos MOREQ10 Mapeados a Conformación de Expedientes según Acuerdo 01/2024</p>
            <div class="stats-bar">
                <div class="stat-item">
                    <div class="stat-number" id="total-reqs">0</div>
                    <div>Requisitos MOREQ10</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">13</div>
                    <div>Conformación de Expedientes</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">7</div>
                    <div>Etapas del Ciclo</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">5</div>
                    <div>Estándares ISO</div>
                </div>
            </div>
        </header>

        <div class="dashboard-controls">
            <div class="control-row">
                <div class="control-group">
                    <label for="search-input">Buscar:</label>
                    <input type="text" id="search-input" class="search-input" placeholder="Buscar por código, requisito o servicio...">
                </div>

                <div class="control-group">
                    <label for="filter-stage">Etapa:</label>
                    <select id="filter-stage">
                        <option value="">Todas las Etapas</option>
                        <option value="produccion">Producción</option>
                        <option value="recepcion">Recepción</option>
                        <option value="distribucion">Distribución</option>
                        <option value="organizacion">Organización</option>
                        <option value="consulta">Consulta</option>
                        <option value="conservacion">Conservación</option>
                        <option value="disposicion">Disposición Final</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="filter-service">Servicio:</label>
                    <select id="filter-service">
                        <option value="">Todos los Servicios</option>
                        <option value="SERVICIOS DEL SISTEMA">Servicios del Sistema</option>
                        <option value="SERVICIO PARA USUARIOS Y GRUPOS">Usuarios y Grupos</option>
                        <option value="SERVICIO MODELO DE ROLES">Modelo de Roles</option>
                        <option value="SERVICIO DE CLASIFICACIÓN">Clasificación</option>
                        <option value="SERVICIO DE REGISTRO">Registro</option>
                        <option value="SERVICIO MODELO DE METADATOS">Metadatos</option>
                        <option value="SERVICIO DE PROGRAMACIÓN DE ElIMINACIÓN">Prog. Eliminación</option>
                        <option value="SERVICIO DE RETENCIÓN DE ELIMINACIÓN">Retención Eliminación</option>
                        <option value="SERVICIO DE BÚSQUEDA E INFORMES">Búsqueda e Informes</option>
                        <option value="SERVICIO DE EXPORTACIÓN">Exportación</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="filter-expediente">Conformación de Expedientes:</label>
                    <select id="filter-expediente">
                        <option value="">Todos los Requisitos</option>
                        <option value="Unidad documental">Unidad documental</option>
                        <option value="Orden lógico y cronológico">Orden lógico y cronológico</option>
                        <option value="Identificación única">Identificación única</option>
                        <option value="Documentos esenciales">Documentos esenciales</option>
                        <option value="Metadatos obligatorios">Metadatos obligatorios</option>
                        <option value="Formato y soporte adecuado">Formato y soporte adecuado</option>
                        <option value="Firma y validación">Firma y validación</option>
                        <option value="Control de versiones">Control de versiones</option>
                        <option value="Cierre formal del expediente">Cierre formal del expediente</option>
                        <option value="Generación de índice electrónico">Generación de índice electrónico</option>
                        <option value="Asociación a serie y subserie documental">Asociación a serie y subserie</option>
                        <option value="Requisitos de accesibilidad">Requisitos de accesibilidad</option>
                        <option value="Integridad del contenido">Integridad del contenido</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="filter-criticidad-exp">Criticidad:</label>
                    <select id="filter-criticidad-exp">
                        <option value="">Todos los Niveles</option>
                        <option value="Alto">Alto</option>
                        <option value="Medio">Medio</option>
                        <option value="Bajo">Bajo</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="filter-iso">ISO:</label>
                    <select id="filter-iso">
                        <option value="">Todos los Estándares</option>
                        <option value="15489">ISO 15489</option>
                        <option value="14721">ISO 14721 OAIS</option>
                        <option value="30301">ISO 30301</option>
                        <option value="27001">ISO/IEC 27001</option>
                        <option value="16175">ISO 16175</option>
                    </select>
                </div>

                <div class="export-group">
                    <button class="btn btn-primary" onclick="exportCSV()">CSV</button>
                    <button class="btn btn-success" onclick="exportExcel()">Excel</button>
                    <button class="btn btn-primary" onclick="printDashboard()">Imprimir</button>
                </div>
            </div>
        </div>

        <div class="filter-summary" id="filter-summary"></div>

        <main class="kanban-container" id="kanban-board">
            <div class="loading">Cargando 174 requisitos MOREQ10 con componentes de expedientes...</div>
        </main>
    </div>

    <script>
        /*
            Autoría del Código JavaScript:
            - Código Original: [Tu Nombre/Entidad Original, si aplica]
            - Modificaciones y Optimizaciones por: Gemini (Google Large Language Model)
            - Fecha de Optimización: Junio de 2025
            - Propósito: Mejora de rendimiento, claridad y mantenimiento de la lógica del dashboard.
        */

        // Base de datos completa con los 174 requisitos MOREQ10
        let moreqRequirements = [];

        // Configuración de las etapas del ciclo de vida
        const lifecycleStages = {
            produccion: {
                title: "Producción",
                description: "Creación y generación de documentos",
                color: "#e3f2fd"
            },
            recepcion: {
                title: "Recepción",
                description: "Ingreso y registro de documentos",
                color: "#f3e5f5"
            },
            distribucion: {
                title: "Distribución",
                description: "Enrutamiento y circulación",
                color: "#e8f5e8"
            },
            organizacion: {
                title: "Organización",
                description: "Clasificación y ordenación",
                color: "#fff3e0"
            },
            consulta: {
                title: "Consulta",
                description: "Acceso y uso de documentos",
                color: "#fce4ec"
            },
            conservacion: {
                title: "Conservación",
                description: "Preservación y mantenimiento",
                color: "#e0f2f1"
            },
            disposicion: {
                title: "Disposición Final",
                description: "Transferencia o eliminación",
                color: "#f1f8e9"
            }
        };

        // Nombres de los niveles de criticidad
        const criticalityLevels = {
            1: "Cumplimiento Normativo",
            2: "Riesgo Legal y Probatorio",
            3: "Dependencia Operacional",
            4: "Sensibilidad de la Información",
            5: "Frecuencia de Acceso",
            6: "Impacto en la Continuidad",
            7: "Obligación de Conservación",
            8: "Costo de Recuperación"
        };

        // Inicializar el dashboard al cargar la página
        document.addEventListener('DOMContentLoaded', function() {
            loadAllMOREQRequirements();
        });

        /**
         * Función para crear un requisito con detección automática de salvedades.
         * @param {object} data - Datos básicos del requisito (código, título, descripción, etapa, criticidad, componentes).
         * @param {string} service - Servicio MOREQ10 al que pertenece el requisito.
         * @param {string[]} isoStandards - Estándares ISO aplicables.
         * @returns {object} El objeto requisito completo.
         */
        function createRequirement(data, service, isoStandards) {
            // Determinar criticidad para expedientes basada en componentes
            let criticidadExpediente = 'Medio';
            if (data.components.includes('Documentos esenciales') ||
                data.components.includes('Identificación única') ||
                data.components.includes('Metadatos obligatorios') ||
                data.components.includes('Integridad del contenido')) {
                criticidadExpediente = 'Alto';
            } else if (data.components.includes('Formato y soporte adecuado') ||
                       data.components.includes('Control de versiones')) {
                criticidadExpediente = 'Bajo';
            }

            // Determinar tipo de gestión y recomendaciones
            let tipoGestion = 'Explícito en MOREQ10';
            let recomendaciones = [];

            if (data.components.includes('Asociación a serie y subserie documental')) {
                tipoGestion = 'Requiere articulación OGD-TI-Jurídica';
                recomendaciones.push('Documentar vinculación con TRD colombianas');
                recomendaciones.push('Articular con normativa AGN');
            }

            if (data.components.includes('Cierre formal del expediente')) {
                recomendaciones.push('Desarrollar flujo de cierre de expedientes');
                recomendaciones.push('Integrar con procesos de transferencia');
            }

            if (data.components.includes('Generación de índice electrónico')) {
                recomendaciones.push('Implementar generación automática de índices');
                recomendaciones.push('Cumplir formato estándar colombiano');
            }

            const requirement = {
                id: data.code,
                title: data.title,
                description: data.desc,
                fullDescription: data.desc + '. Requisito MOREQ10 implementado según estándares internacionales de gestión documental electrónica.',
                stage: data.stage,
                service: service,
                criticality: data.crit,
                isoStandards: isoStandards,
                componentesExpediente: data.components,
                criticidadExpediente: criticidadExpediente,
                tipoGestion: tipoGestion,
                recomendaciones: recomendaciones
            };

            // Verificar si requiere salvedad y ajustar tipo de gestión y recomendaciones
            if (!hasSpecificExpedienteBinding(requirement)) {
                requirement.tipoGestion = 'Requiere documentación de reglas de negocio por la entidad';
                requirement.recomendaciones.push('La entidad debe documentar cómo este requisito aplica a sus expedientes');
                requirement.recomendaciones.push('Definir reglas de negocio específicas según contexto organizacional');
                requirement.recomendaciones.push('Coordinar implementación entre OGD, TI y área jurídica');
            }

            return requirement;
        }

        /**
         * Procesa y carga todos los 174 requisitos MOREQ10 con componentes de expedientes.
         */
        async function loadAllMOREQRequirements() {
            try {
                // Simular la carga de los datos procesados
                moreqRequirements = generateAll174RequirementsWithComponents();

                console.log(`✅ ${moreqRequirements.length} requisitos MOREQ10 cargados con componentes de expedientes`);

                initializeDashboard();
                setupEventListeners();
                showSalvedadStats(); // Llamar directamente después de la inicialización
            } catch (error) {
                console.error('Error cargando datos MOREQ:', error);
                document.getElementById('kanban-board').innerHTML = '<div class="loading">Error cargando requisitos MOREQ10</div>';
            }
        }

        /**
         * Genera los 174 requisitos MOREQ10 completos con componentes de expedientes.
         * Esta función simula una base de datos de requisitos.
         * @returns {Array<object>} Lista de requisitos MOREQ10.
         */
        function generateAll174RequirementsWithComponents() {
            const allReqs = [];

            // SERVICIOS DEL SISTEMA (28 requisitos)
            const sistemasData = [
                { code: 'R2.4.1', title: 'Servicios Core del SGDEA', desc: 'Un SGDEA debe implementar la funcionalidad de servicios core', stage: 'produccion', crit: 1, components: ['Unidad documental', 'Identificación única', 'Metadatos obligatorios'] },
                { code: 'R2.4.2', title: 'Inicialización de Metadatos', desc: 'Inicializar metadatos de servicios en instalación', stage: 'produccion', crit: 1, components: ['Metadatos obligatorios', 'Identificación única'] },
                { code: 'R2.4.3', title: 'Navegación por Servicios', desc: 'Permitir navegación por servicios o paquetes', stage: 'consulta', crit: 5, components: ['Requisitos de accesibilidad', 'Generación de índice electrónico'] },
                { code: 'R2.4.4', title: 'Modificación de Metadatos', desc: 'Modificar metadatos de servicios', stage: 'organizacion', crit: 3, components: ['Metadatos obligatorios', 'Control de versiones'] },
                { code: 'R2.4.5', title: 'Informe de Cumplimiento', desc: 'Generar informe de cumplimiento MoReq2010', stage: 'consulta', crit: 1, components: ['Generación de índice electrónico', 'Documentos esenciales'] }
            ];
            // Generar el resto de servicios del sistema
            for (let i = 6; i <= 28; i++) {
                const stage = i <= 10 ? 'organizacion' : (i <= 20 ? 'consulta' : 'conservacion');
                const crit = i <= 10 ? 3 : (i <= 20 ? 5 : 6);
                const components = i <= 10 ? ['Unidad documental', 'Control de versiones'] :
                                  i <= 20 ? ['Requisitos de accesibilidad', 'Generación de índice electrónico'] :
                                  ['Integridad del contenido', 'Formato y soporte adecuado'];

                sistemasData.push({
                    code: `R2.4.${i}`,
                    title: `Gestión del Sistema ${i}`,
                    desc: `Funcionalidad ${i} del sistema de gestión documental`,
                    stage: stage,
                    crit: crit,
                    components: components
                });
            }
            sistemasData.forEach(req => {
                allReqs.push(createRequirement(req, 'SERVICIOS DEL SISTEMA', ['15489', '30301']));
            });

            // SERVICIO PARA USUARIOS Y GRUPOS (14 requisitos)
            for (let i = 1; i <= 14; i++) {
                allReqs.push(createRequirement({
                    code: `R3.1.${i}`,
                    title: `Gestión de Usuarios ${i}`,
                    desc: `Gestión completa de usuarios y grupos organizacionales`,
                    stage: 'organizacion',
                    crit: 4,
                    components: ['Requisitos de accesibilidad', 'Firma y validación', 'Identificación única']
                }, 'SERVICIO PARA USUARIOS Y GRUPOS', ['27001', '15489']));
            }

            // SERVICIO MODELO DE ROLES (15 requisitos)
            for (let i = 1; i <= 15; i++) {
                const stage = i <= 5 ? 'organizacion' : 'consulta';
                allReqs.push(createRequirement({
                    code: `R4.1.${i}`,
                    title: `Modelo de Roles ${i}`,
                    desc: `Implementar modelo de roles y permisos granulares`,
                    stage: stage,
                    crit: 4,
                    components: ['Requisitos de accesibilidad', 'Firma y validación', 'Control de versiones']
                }, 'SERVICIO MODELO DE ROLES', ['27001', '15489']));
            }

            // SERVICIO DE CLASIFICACIÓN (8 requisitos)
            for (let i = 1; i <= 8; i++) {
                allReqs.push(createRequirement({
                    code: `R5.1.${i}`,
                    title: `Clasificación Documental ${i}`,
                    desc: `Implementar esquemas de clasificación jerárquicos`,
                    stage: 'organizacion',
                    crit: 1,
                    components: ['Asociación a serie y subserie documental', 'Orden lógico y cronológico', 'Identificación única']
                }, 'SERVICIO DE CLASIFICACIÓN', ['15489', '30301']));
            }

            // SERVICIO DE REGISTRO (21 requisitos)
            for (let i = 1; i <= 21; i++) {
                const stage = i <= 8 ? 'produccion' : 'organizacion';
                const crit = i <= 8 ? 1 : 3;
                const components = i <= 8 ?
                    ['Unidad documental', 'Metadatos obligatorios', 'Identificación única'] :
                    ['Control de versiones', 'Formato y soporte adecuado', 'Orden lógico y cronológico'];

                allReqs.push(createRequirement({
                    code: `R6.1.${i}`,
                    title: `Gestión de Registros ${i}`,
                    desc: `Gestionar captura, declaración y mantenimiento de registros`,
                    stage: stage,
                    crit: crit,
                    components: components
                }, 'SERVICIO DE REGISTRO', ['15489', '16175']));
            }

            // SERVICIO MODELO DE METADATOS (20 requisitos)
            for (let i = 1; i <= 20; i++) {
                const stage = i <= 5 ? 'produccion' : 'organizacion';
                const crit = i <= 5 ? 2 : 3;

                allReqs.push(createRequirement({
                    code: `R7.1.${i}`,
                    title: `Metadatos ${i}`,
                    desc: `Gestionar esquemas de metadatos configurables`,
                    stage: stage,
                    crit: crit,
                    components: ['Metadatos obligatorios', 'Formato y soporte adecuado', 'Identificación única']
                }, 'SERVICIO MODELO DE METADATOS', ['15489', '16175']));
            }

            // SERVICIO DE PROGRAMACIÓN DE ELIMINACIÓN (24 requisitos)
            for (let i = 1; i <= 24; i++) {
                const components = i <= 8 ?
                    ['Cierre formal del expediente', 'Asociación a serie y subserie documental'] :
                    i <= 16 ? ['Generación de índice electrónico', 'Integridad del contenido'] :
                    ['Control de versiones', 'Documentos esenciales'];

                allReqs.push(createRequirement({
                    code: `R8.1.${i}`,
                    title: `Programación Eliminación ${i}`,
                    desc: `Gestionar programas de eliminación y evaluación documental`,
                    stage: 'disposicion',
                    crit: 7,
                    components: components
                }, 'SERVICIO DE PROGRAMACIÓN DE ElIMINACIÓN', ['15489', '30301']));
            }

            // SERVICIO DE RETENCIÓN DE ELIMINACIÓN (7 requisitos)
            for (let i = 1; i <= 7; i++) {
                allReqs.push(createRequirement({
                    code: `R9.1.${i}`,
                    title: `Retención Legal ${i}`,
                    desc: `Gestionar holds legales y suspensiones de eliminación`,
                    stage: 'disposicion',
                    crit: 2,
                    components: ['Cierre formal del expediente', 'Control de versiones', 'Firma y validación']
                }, 'SERVICIO DE RETENCIÓN DE ELIMINACIÓN', ['15489', '27001']));
            }

            // SERVICIO DE BÚSQUEDA E INFORMES (27 requisitos)
            for (let i = 1; i <= 27; i++) {
                const components = i <= 9 ?
                    ['Requisitos de accesibilidad', 'Generación de índice electrónico'] :
                    i <= 18 ? ['Metadatos obligatorios', 'Orden lógico y cronológico'] :
                    ['Formato y soporte adecuado', 'Unidad documental'];

                allReqs.push(createRequirement({
                    code: `R10.1.${i}`,
                    title: `Búsqueda e Informes ${i}`,
                    desc: `Proporcionar capacidades avanzadas de búsqueda y reportes`,
                    stage: 'consulta',
                    crit: 5,
                    components: components
                }, 'SERVICIO DE BÚSQUEDA E INFORMES', ['15489', '16175']));
            }

            // SERVICIO DE EXPORTACIÓN (10 requisitos)
            for (let i = 1; i <= 10; i++) {
                const crit = i <= 5 ? 5 : 7;
                const components = i <= 5 ?
                    ['Generación de índice electrónico', 'Formato y soporte adecuado'] :
                    ['Cierre formal del expediente', 'Integridad del contenido'];

                allReqs.push(createRequirement({
                    code: `R11.1.${i}`,
                    title: `Exportación ${i}`,
                    desc: `Permitir exportación de registros y creación de paquetes`,
                    stage: 'disposicion',
                    crit: crit,
                    components: components
                }, 'SERVICIO DE EXPORTACIÓN', ['15489', '14721']));
            }

            return allReqs;
        }

        /**
         * Inicializa el dashboard, creando las columnas y los elementos kanban.
         */
        function initializeDashboard() {
            const kanbanBoard = document.getElementById('kanban-board');

            // Limpiar contenido existente
            kanbanBoard.innerHTML = '';

            // Actualizar estadísticas
            document.getElementById('total-reqs').textContent = moreqRequirements.length;

            // Crear columnas para cada etapa del ciclo de vida
            Object.keys(lifecycleStages).forEach(stageKey => {
                const stage = lifecycleStages[stageKey];
                const stageRequirements = moreqRequirements.filter(req => req.stage === stageKey);

                const column = createKanbanColumn(stageKey, stage, stageRequirements);
                kanbanBoard.appendChild(column);
            });

            updateFilterSummary();
        }

        /**
         * Crea una columna Kanban para una etapa específica.
         * @param {string} stageKey - Clave de la etapa del ciclo de vida.
         * @param {object} stage - Objeto de configuración de la etapa.
         * @param {Array<object>} requirements - Requisitos asociados a esta etapa.
         * @returns {HTMLElement} El elemento de la columna Kanban.
         */
        function createKanbanColumn(stageKey, stage, requirements) {
            const column = document.createElement('div');
            column.className = 'kanban-column';
            column.dataset.stage = stageKey;

            const header = document.createElement('div');
            header.className = 'kanban-column-header';
            header.style.background = `linear-gradient(135deg, ${stage.color}, #6c757d)`;
            header.innerHTML = `
                <h3>${stage.title}</h3>
                <div class="column-count">${requirements.length}</div>
                <div style="font-size: 0.8rem; margin-top: 0.25rem; opacity: 0.9;">
                    ${stage.description}
                </div>
            `;

            const content = document.createElement('div');
            content.className = 'kanban-column-content';

            requirements.forEach(requirement => {
                const item = createKanbanItem(requirement);
                content.appendChild(item);
            });

            column.appendChild(header);
            column.appendChild(content);

            return column;
        }

        /**
         * Crea un elemento Kanban para un requisito.
         * @param {object} requirement - El objeto requisito.
         * @returns {HTMLElement} El elemento del ítem Kanban.
         */
        function createKanbanItem(requirement) {
            const item = document.createElement('div');
            item.className = `kanban-item criticidad-${requirement.criticality}`;
            item.dataset.id = requirement.id;
            item.dataset.stage = requirement.stage;
            item.dataset.criticality = requirement.criticality;
            item.dataset.service = requirement.service;
            item.dataset.isoStandards = requirement.isoStandards.join(',');
            item.dataset.componentesExpediente = requirement.componentesExpediente.join(',');
            item.dataset.criticidadExpediente = requirement.criticidadExpediente;
            item.tabIndex = 0;

            // Truncar descripciones largas para una mejor visualización
            const shortDescription = requirement.description.length > 80
                ? requirement.description.substring(0, 80) + '...'
                : requirement.description;

            // Obtener abreviatura del servicio para la insignia
            const serviceAbbr = getServiceAbbreviation(requirement.service);

            // Obtener componente principal para mostrar
            const primaryComponent = requirement.componentesExpediente[0] || 'N/A';

            item.innerHTML = `
                <div class="item-header">
                    <div class="item-id">${requirement.id}</div>
                </div>
                <div class="item-title">${requirement.title}</div>
                <div class="item-description">${shortDescription}</div>
                <div class="item-metadata">
                    <div class="metadata-tag tag-${getCriticalityClass(requirement.criticality)}">
                        N${requirement.criticality}
                    </div>
                    <div class="metadata-tag crit-exp-${requirement.criticidadExpediente.toLowerCase()}">
                        ${requirement.criticidadExpediente}
                    </div>
                    <div class="expediente-tag">
                        ${primaryComponent.substring(0, 20)}${primaryComponent.length > 20 ? '...' : ''}
                    </div>
                </div>
                <div class="item-footer">
                    <div class="iso-badges">
                        ${requirement.isoStandards.map(iso =>
                            `<span class="iso-badge">ISO ${iso}</span>`
                        ).join('')}
                    </div>
                    <div class="service-badge">
                        ${serviceAbbr}
                    </div>
                </div>
            `;

            // Agregar evento de clic para los detalles del elemento con verificación de salvedad
            item.addEventListener('click', () => {
                // Verificar si el requisito tiene vinculación específica con expedientes
                if (hasSpecificExpedienteBinding(requirement)) {
                    showItemDetails(requirement);
                } else {
                    showSalvedadModal(requirement);
                }
            });

            return item;
        }

        /**
         * Obtiene la abreviatura de un servicio.
         * @param {string} service - Nombre completo del servicio.
         * @returns {string} Abreviatura del servicio.
         */
        function getServiceAbbreviation(service) {
            const abbreviations = {
                'SERVICIOS DEL SISTEMA': 'SIS',
                'SERVICIO PARA USUARIOS Y GRUPOS': 'USR',
                'SERVICIO MODELO DE ROLES': 'ROL',
                'SERVICIO DE CLASIFICACIÓN': 'CLS',
                'SERVICIO DE REGISTRO': 'REG',
                'SERVICIO MODELO DE METADATOS': 'MET',
                'SERVICIO DE PROGRAMACIÓN DE ElIMINACIÓN': 'ELI',
                'SERVICIO DE RETENCIÓN DE ELIMINACIÓN': 'RET',
                'SERVICIO DE BÚSQUEDA E INFORMES': 'BUS',
                'SERVICIO DE EXPORTACIÓN': 'EXP'
            };
            return abbreviations[service] || 'SRV';
        }

        /**
         * Obtiene la clase CSS para el nivel de criticidad general.
         * @param {number} level - Nivel de criticidad (1-8).
         * @returns {string} Clase CSS correspondiente.
         */
        function getCriticalityClass(level) {
            const classes = {
                1: 'cumplimiento',
                2: 'riesgo',
                3: 'dependencia',
                4: 'sensibilidad',
                5: 'frecuencia',
                6: 'continuidad',
                7: 'conservacion',
                8: 'recuperacion'
            };
            return classes[level] || 'cumplimiento';
        }

        /**
         * CRITERIO DE DETECCIÓN MEJORADO para vinculación específica con expedientes.
         * Determina si un requisito tiene una vinculación directa y específica con la conformación de expedientes.
         * @param {object} requirement - El objeto requisito.
         * @returns {boolean} True si tiene vinculación específica, false si requiere salvedad.
         */
        function hasSpecificExpedienteBinding(requirement) {
            const servicioLower = requirement.service.toLowerCase();
            const reqLower = requirement.description.toLowerCase();
            const titleLower = requirement.title.toLowerCase();
            const fullText = (reqLower + ' ' + titleLower + ' ' + servicioLower).toLowerCase();

            // CRITERIO 1: Casos que SIEMPRE requieren salvedad (máxima prioridad)
            // Estos son requisitos de sistema o funciones muy genéricas sin contexto documental claro.
            const alwaysSalvedadPatterns = [
                /R2\.4\.(3|6|7|11|12|13|14|17|18|23|27|28)/, // IDs específicos de servicios del sistema
                /navegue.*entidad/, // Navegación de entidades abstractas
                /vínculo.*entidad/, // Vínculos técnicos de entidades
                /diagnóstico.*servicio/, // Diagnósticos de servicio técnico
                /configurar.*sistema/, // Configuraciones de sistema genéricas
                /cumplimiento.*servicio/, // Cumplimiento técnico de servicio
            ];
            if (alwaysSalvedadPatterns.some(pattern => pattern.test(requirement.id) || pattern.test(fullText))) {
                return false;
            }

            // CRITERIO 2: Servicios con vinculación directa y fuerte a expedientes
            // Estos servicios por su naturaleza implican gestión documental.
            const directBindingServices = ['registro', 'clasificación', 'metadatos', 'búsqueda', 'exportación', 'eliminación', 'retención'];
            if (directBindingServices.some(service => servicioLower.includes(service))) {
                return true;
            }

            // CRITERIO 3: Palabras clave que indican un contexto documental directo
            // Términos que se refieren explícitamente a la gestión de documentos, registros o expedientes.
            const expedienteKeywords = [
                // Términos directos de expedientes
                'expediente', 'registro', 'documento', 'captura', 'declarar',

                // Términos de clasificación y organización
                'clasificación', 'clasificar', 'serie', 'subserie', 'categoría',
                'orden', 'jerarquía', 'estructura', 'organizar', 'ordenar',

                // Términos de metadatos y descripción
                'metadatos', 'metadata', 'descripción', 'esquema', 'atributos',

                // Términos de preservación y conservación
                'preservar', 'conservar', 'integridad', 'autenticidad', 'preservación',
                'mantener', 'proteger', 'verificar',

                // Términos de transferencia y disposición
                'transferir', 'eliminar', 'exportar', 'disposición', 'retención',
                'archivo', 'eliminación', 'destruir', 'migrar',

                // Términos de búsqueda y acceso
                'buscar', 'consultar', 'recuperar', 'localizar', 'encontrar',
                'índice', 'indexar', 'catálogo', 'inventario',

                // Términos de validación y firma
                'firmar', 'validar', 'autenticar', 'certificar', 'aprobar',
                'firma', 'sello', 'timestamp',

                // Términos de versiones y control
                'versión', 'versionado', 'cambio', 'modificación', 'actualizar',
                'historial', 'seguimiento', 'trazabilidad'
            ];
            if (expedienteKeywords.some(keyword => fullText.includes(keyword))) {
                return true;
            }

            // CRITERIO 4: Usuarios y roles - solo si tienen un contexto documental específico
            // Si es un servicio de usuario/rol y no se encontraron palabras clave de documento directas,
            // es probable que sea una salvedad (gestión de usuarios/roles sin impacto directo en expedientes).
            if (servicioLower.includes('usuario') || servicioLower.includes('rol')) {
                const hasDocumentContextInUsersRoles = [
                    'documento', 'registro', 'expediente', 'clasificación', 'metadatos', 'firma'
                ].some(keyword => fullText.includes(keyword));
                if (!hasDocumentContextInUsersRoles) {
                    return false;
                }
            }

            // Si no se cumple ninguna de las condiciones anteriores, se considera una salvedad por defecto.
            return false;
        }

        /**
         * Obtiene una explicación del criterio de detección aplicado a un requisito.
         * @param {object} requirement - El objeto requisito.
         * @returns {string} Explicación del criterio.
         */
        function getDetectionExplanation(requirement) {
            const hasBinding = hasSpecificExpedienteBinding(requirement);
            const servicioLower = requirement.service.toLowerCase();
            const reqLower = requirement.description.toLowerCase();
            const titleLower = requirement.title.toLowerCase();
            const fullText = (reqLower + ' ' + titleLower + ' ' + servicioLower).toLowerCase();

            if (hasBinding) {
                let reasons = [];
                const directBindingServices = ['registro', 'clasificación', 'metadatos', 'búsqueda', 'exportación', 'eliminación', 'retención'];
                directBindingServices.forEach(service => {
                    if (servicioLower.includes(service)) reasons.push(`Servicio de ${service} (vinculación directa)`);
                });

                const expedienteKeywords = ['documento', 'registro', 'expediente', 'preservar', 'conservar', 'clasificación', 'metadatos', 'firma', 'versión', 'índice'];
                expedienteKeywords.forEach(keyword => {
                    if (fullText.includes(keyword)) reasons.push(`Menciona "${keyword}"`);
                });

                return reasons.length > 0 ? reasons.join('; ') : 'Vinculación inferida por contexto general de expediente';
            } else {
                let reasons = [];
                const alwaysSalvedadPatterns = [
                    { pattern: /R2\.4\.(3|6|7|11|12|13|14|17|18|23|27|28)/, desc: 'Servicio del Sistema sin contexto documental específico' },
                    { pattern: /navegue.*entidad/, desc: 'Función de navegación de sistema' },
                    { pattern: /diagnóstico.*servicio/, desc: 'Función de diagnóstico técnico' },
                    { pattern: /entidad/i, desc: 'Gestión de entidades abstractas del sistema (sin contexto documental)' },
                    { pattern: /vínculo/i, desc: 'Vínculos técnicos de sistema (sin contexto documental)' },
                ];

                alwaysSalvedadPatterns.some(item => {
                    if (item.pattern.test(requirement.id) || item.pattern.test(fullText)) {
                        reasons.push(item.desc);
                        return true;
                    }
                    return false;
                });

                if (servicioLower.includes('usuario') || servicioLower.includes('rol')) {
                    const hasDocumentContextInUsersRoles = [
                        'documento', 'registro', 'expediente', 'clasificación', 'metadatos', 'firma'
                    ].some(keyword => fullText.includes(keyword));
                    if (!hasDocumentContextInUsersRoles) {
                        reasons.push('Gestión de usuarios/roles sin contexto documental específico');
                    }
                }

                return reasons.length > 0 ? reasons.join('; ') : 'Sin términos específicos de conformación de expedientes o funciones puramente de sistema';
            }
        }

        /**
         * Muestra un modal de salvedad para requisitos sin vinculación específica.
         * @param {object} requirement - El objeto requisito.
         */
        function showSalvedadModal(requirement) {
            const modal = document.createElement('div');
            modal.className = 'salvedad-modal';

            const content = document.createElement('div');
            content.className = 'salvedad-content';

            content.innerHTML = `
                <div class="salvedad-header">
                    <div class="salvedad-icon">⚠️</div>
                    <h2>SALVEDAD IMPORTANTE</h2>
                    <p>Requisito sin Vinculación Específica con Expedientes</p>
                </div>

                <div class="salvedad-body">
                    <h3>📋 Requisito: ${requirement.id} - ${requirement.title}</h3>
                    <p><strong>Servicio MOREQ10:</strong> ${requirement.service}</p>

                    <hr style="margin: 1rem 0; border: 1px solid #ffc107;">

                    <h4>🔍 Análisis de Vinculación:</h4>
                    <p>Este requisito de MOREQ10 <strong>NO está vinculado específicamente</strong> con los componentes de conformación de expedientes definidos en el Acuerdo 01 de 2024.</p>

                    <p><strong>🎯 Criterio de Detección:</strong> ${getDetectionExplanation(requirement)}</p>

                    <h4>📝 Responsabilidad de la Entidad:</h4>
                    <ul style="margin-left: 1.5rem; margin-top: 0.5rem;">
                        <li><strong>Documentar</strong> las reglas de negocio específicas</li>
                        <li><strong>Definir</strong> cómo este requisito aplica a sus expedientes</li>
                        <li><strong>Establecer</strong> procedimientos de implementación</li>
                        <li><strong>Coordinar</strong> entre OGD, TI y áreas jurídicas</li>
                        <li><strong>Ampliar</strong> el mapeo MOREQ10 según contexto organizacional</li>
                    </ul>

                    <h4>🎯 Recomendación:</h4>
                    <p>La entidad debe realizar un análisis específico para determinar:</p>
                    <ul style="margin-left: 1.5rem; margin-top: 0.5rem;">
                        <li>¿Cómo impacta este requisito la gestión de expedientes?</li>
                        <li>¿Qué reglas de negocio son necesarias?</li>
                        <li>¿Cómo se documenta y normaliza la implementación?</li>
                    </ul>
                </div>

                <div class="salvedad-actions">
                    <button class="btn btn-warning" onclick="showItemDetails_afterSalvedad('${requirement.id}'); this.closest('.salvedad-modal').remove();">
                        📖 Ver Detalles del Requisito
                    </button>
                    <button class="btn btn-danger" onclick="this.closest('.salvedad-modal').remove();">
                        ❌ Cerrar Salvedad
                    </button>
                </div>
            `;

            modal.appendChild(content);
            document.body.appendChild(modal);

            // Cerrar al hacer clic en el fondo
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });

            // Cerrar con la tecla Escape
            document.addEventListener('keydown', function escapeHandler(e) {
                if (e.key === 'Escape') {
                    modal.remove();
                    document.removeEventListener('keydown', escapeHandler);
                }
            });
        }

        /**
         * Muestra los detalles de un requisito después de cerrar el modal de salvedad.
         * @param {string} requirementId - ID del requisito.
         */
        function showItemDetails_afterSalvedad(requirementId) {
            const requirement = moreqRequirements.find(req => req.id === requirementId);
            if (requirement) {
                showItemDetails(requirement);
            }
        }

        /**
         * Configura los escuchadores de eventos para la búsqueda y los filtros.
         */
        function setupEventListeners() {
            // Funcionalidad de búsqueda
            const searchInput = document.getElementById('search-input');
            searchInput.addEventListener('input', debounce(handleSearch, 300));

            // Funcionalidad de filtro
            document.getElementById('filter-stage').addEventListener('change', handleFilter);
            document.getElementById('filter-service').addEventListener('change', handleFilter);
            document.getElementById('filter-expediente').addEventListener('change', handleFilter);
            document.getElementById('filter-criticidad-exp').addEventListener('change', handleFilter);
            document.getElementById('filter-iso').addEventListener('change', handleFilter);
        }

        /**
         * Maneja el evento de búsqueda, filtrando los elementos Kanban.
         * @param {Event} event - El evento de entrada.
         */
        function handleSearch(event) {
            const query = event.target.value.toLowerCase().trim();
            const items = document.querySelectorAll('.kanban-item');

            items.forEach(item => {
                const title = item.querySelector('.item-title').textContent.toLowerCase();
                const description = item.querySelector('.item-description').textContent.toLowerCase();
                const id = item.dataset.id.toLowerCase();
                const service = item.dataset.service.toLowerCase();
                const componentes = item.dataset.componentesExpediente.toLowerCase();

                const matches = !query ||
                    title.includes(query) ||
                    description.includes(query) ||
                    id.includes(query) ||
                    service.includes(query) ||
                    componentes.includes(query);

                item.style.display = matches ? 'block' : 'none';
            });

            updateColumnCounts();
            updateFilterSummary();
        }

        /**
         * Maneja los eventos de filtro, aplicando los filtros seleccionados.
         */
        function handleFilter() {
            const stageFilter = document.getElementById('filter-stage').value;
            const serviceFilter = document.getElementById('filter-service').value;
            const expedienteFilter = document.getElementById('filter-expediente').value;
            const criticidadExpFilter = document.getElementById('filter-criticidad-exp').value;
            const isoFilter = document.getElementById('filter-iso').value;

            const items = document.querySelectorAll('.kanban-item');

            items.forEach(item => {
                const matchesStage = !stageFilter || item.dataset.stage === stageFilter;
                const matchesService = !serviceFilter || item.dataset.service === serviceFilter;
                const matchesExpediente = !expedienteFilter || item.dataset.componentesExpediente.includes(expedienteFilter);
                const matchesCriticidadExp = !criticidadExpFilter || item.dataset.criticidadExpediente === criticidadExpFilter;
                const matchesIso = !isoFilter || item.dataset.isoStandards.includes(isoFilter);

                const isVisible = matchesStage && matchesService && matchesExpediente && matchesCriticidadExp && matchesIso;
                item.style.display = isVisible ? 'block' : 'none';
            });

            updateColumnCounts();
            updateFilterSummary();
        }

        /**
         * Actualiza el conteo de elementos visibles en cada columna Kanban.
         */
        function updateColumnCounts() {
            document.querySelectorAll('.kanban-column').forEach(column => {
                const visibleItems = column.querySelectorAll('.kanban-item:not([style*="display: none"])').length;
                const countElement = column.querySelector('.column-count');
                countElement.textContent = visibleItems;
            });
        }

        /**
         * Actualiza el resumen de filtros, mostrando cuántos elementos son visibles.
         */
        function updateFilterSummary() {
            const totalItems = moreqRequirements.length;
            const visibleItems = document.querySelectorAll('.kanban-item:not([style*="display: none"])').length;
            const summary = document.getElementById('filter-summary');

            if (visibleItems < totalItems) {
                summary.textContent = `Mostrando ${visibleItems} de ${totalItems} requisitos MOREQ10`;
                summary.classList.add('active');
            } else {
                summary.classList.remove('active');
            }
        }

        /**
         * Muestra un modal con los detalles completos de un requisito.
         * @param {object} requirement - El objeto requisito.
         */
        function showItemDetails(requirement) {
            const modal = document.createElement('div');
            modal.className = 'modal';

            const content = document.createElement('div');
            content.className = 'modal-content';

            content.innerHTML = `
                <div class="modal-header">
                    <h2>${requirement.title}</h2>
                    <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                </div>
                <div class="modal-body">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                        <div>
                            <h3>Información MOREQ10</h3>
                            <p><strong>Código:</strong> ${requirement.id}</p>
                            <p><strong>Servicio:</strong> ${requirement.service}</p>
                            <p><strong>Etapa del Ciclo:</strong> ${lifecycleStages[requirement.stage].title}</p>
                            <p><strong>Criticidad General:</strong> ${requirement.criticality} - ${criticalityLevels[requirement.criticality]}</p>
                            <p><strong>Estándares ISO:</strong> ${requirement.isoStandards.map(iso => `ISO ${iso}`).join(', ')}</p>
                        </div>
                        <div>
                            <h3>Información de Expedientes</h3>
                            <p><strong>Criticidad para Expedientes:</strong>
                                <span class="metadata-tag crit-exp-${requirement.criticidadExpediente.toLowerCase()}">${requirement.criticidadExpediente}</span>
                            </p>
                            <p><strong>Tipo de Gestión:</strong> ${requirement.tipoGestion}</p>
                            <p><strong>Expedientes Relacionados:</strong></p>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;">
                                ${requirement.componentesExpediente.map(comp =>
                                    `<span class="expediente-tag">${comp}</span>`
                                ).join('')}
                            </div>

                            ${!hasSpecificExpedienteBinding(requirement) ? `
                            <div style="background: #fff3cd; padding: 0.75rem; border-radius: 4px; margin-top: 1rem; border-left: 4px solid #ffc107;">
                                <p style="font-size: 0.9rem; margin: 0;"><strong>⚠️ Salvedad:</strong> Este requisito requiere que la entidad documente reglas de negocio específicas para su vinculación con expedientes.</p>
                            </div>
                            ` : ''}
                        </div>
                    </div>

                    <h3>Descripción Completa:</h3>
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin: 1rem 0; line-height: 1.6;">
                        ${requirement.fullDescription}
                    </div>

                    <h3>Análisis de Implementación:</h3>
                    <div style="background: #e3f2fd; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                        <p><strong>Contexto de Conformación de Expedientes:</strong> ${getExpedienteDescription(requirement.componentesExpediente)}</p>
                        <p><strong>Nivel de Criticidad:</strong> ${getCriticalityExpedienteExplanation(requirement.criticidadExpediente)}</p>
                        <p><strong>Estándares ISO Aplicables:</strong> ${getISOExplanation(requirement.isoStandards)}</p>
                        <p><strong>Criterio de Detección Aplicado:</strong> ${getDetectionExplanation(requirement)}</p>

                        ${!hasSpecificExpedienteBinding(requirement) ? `
                        <div style="background: #dc3545; color: white; padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                            <h4 style="margin: 0 0 0.5rem 0;">⚠️ SALVEDAD CRÍTICA</h4>
                            <p style="margin: 0; font-size: 0.9rem;">Este requisito MOREQ10 NO tiene vinculación específica con conformación de expedientes. La entidad DEBE documentar las reglas de negocio necesarias para ampliar el mapeo según su contexto organizacional.</p>
                        </div>
                        ` : ''}
                    </div>

                    ${requirement.recomendaciones.length > 0 ? `
                    <h3>Recomendaciones de Implementación:</h3>
                    <div style="background: #fff3cd; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                        <ul style="margin-left: 1.5rem;">
                            ${requirement.recomendaciones.map(rec => `<li>${rec}</li>`).join('')}
                        </ul>
                    </div>
                    ` : ''}

                    <div style="background: #d1ecf1; padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                        <p><strong>Contexto Normativo Colombiano:</strong></p>
                        <p>Este requisito ha sido mapeado al ciclo de vida del expediente según el Acuerdo 01 de 2024 del Archivo General de la Nación de Colombia, garantizando cumplimiento normativo y mejor gestión documental electrónica.</p>
                        ${requirement.tipoGestion === 'Requiere articulación OGD-TI-Jurídica' ?
                            '<p><strong>⚠️ Atención:</strong> Este requisito requiere trabajo conjunto entre la Oficina de Gestión Documental, el área de TI y el área jurídica para su correcta implementación en el contexto colombiano.</p>' : ''}
                    </div>
                </div>
            `;

            modal.appendChild(content);
            document.body.appendChild(modal);

            // Cerrar al hacer clic en el fondo
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });

            // Cerrar con la tecla Escape
            document.addEventListener('keydown', function escapeHandler(e) {
                if (e.key === 'Escape') {
                    modal.remove();
                    document.removeEventListener('keydown', escapeHandler);
                }
            });
        }

        /**
         * Obtiene una descripción de los componentes de expediente.
         * @param {string[]} componentes - Array de nombres de componentes.
         * @returns {string} Descripción concatenada de los componentes.
         */
        function getExpedienteDescription(componentes) {
            const descriptions = {
                'Unidad documental': 'Gestión de documentos individuales como unidades básicas',
                'Orden lógico y cronológico': 'Mantenimiento del orden temporal y lógico de documentos',
                'Identificación única': 'Sistema de identificación inequívoca de documentos',
                'Documentos esenciales': 'Gestión de documentos críticos para el expediente',
                'Metadatos obligatorios': 'Captura y gestión de metadatos requeridos',
                'Formato y soporte adecuado': 'Gestión de formatos y soportes documentales',
                'Firma y validación': 'Procesos de autenticación y validación',
                'Control de versiones': 'Gestión de versiones y cambios documentales',
                'Cierre formal del expediente': 'Procesos de finalización de expedientes',
                'Generación de índice electrónico': 'Creación automática de índices',
                'Asociación a serie y subserie documental': 'Vinculación con clasificación archivística',
                'Requisitos de accesibilidad': 'Garantía de acceso según permisos',
                'Integridad del contenido': 'Preservación de la integridad documental'
            };

            return componentes.map(comp => descriptions[comp] || comp).join('; ');
        }

        /**
         * Obtiene una explicación del nivel de criticidad para expedientes.
         * @param {string} level - Nivel de criticidad ('Alto', 'Medio', 'Bajo').
         * @returns {string} Explicación del nivel.
         */
        function getCriticalityExpedienteExplanation(level) {
            const explanations = {
                'Alto': 'Crítico para la conformación y validez legal del expediente. Cumplimiento obligatorio.',
                'Medio': 'Importante para la gestión eficiente del expediente. Recomendado implementar.',
                'Bajo': 'Facilita la gestión pero no es crítico. Implementación según recursos disponibles.'
            };
            return explanations[level] || 'Nivel no definido';
        }

        /**
         * Obtiene una explicación de los estándares ISO aplicables.
         * @param {string[]} standards - Array de estándares ISO.
         * @returns {string} Explicación concatenada de los estándares.
         */
        function getISOExplanation(standards) {
            const explanations = {
                "15489": "Gestión de documentos y registros - Principios y requisitos",
                "14721": "Preservación digital y modelo OAIS - Archivo abierto",
                "30301": "Sistemas de gestión para documentos - SGD",
                "27001": "Seguridad de la información - SGSI",
                "16175": "Documentos electrónicos y metadatos - Oficina electrónica"
            };

            return standards.map(std => `ISO ${std}: ${explanations[std] || 'Estándar internacional relacionado'}`).join('; ');
        }

        /**
         * Exporta los requisitos visibles a un archivo CSV.
         */
        function exportCSV() {
            const visibleRequirements = getVisibleRequirements();
            const csvContent = convertToCSV(visibleRequirements);
            downloadFile(csvContent, 'moreq10-expedientes-colombianos.csv', 'text/csv');
        }

        /**
         * Exporta los requisitos visibles a un archivo Excel (usando formato CSV con tabuladores).
         */
        function exportExcel() {
            const visibleRequirements = getVisibleRequirements();
            const csvContent = convertToCSV(visibleRequirements, '\t');
            downloadFile(csvContent, 'moreq10-expedientes-colombianos.xls', 'application/vnd.ms-excel');
        }

        /**
         * Imprime el contenido del dashboard.
         */
        function printDashboard() {
            window.print();
        }

        /**
         * Obtiene los requisitos actualmente visibles en el dashboard.
         * @returns {Array<object>} Lista de requisitos visibles.
         */
        function getVisibleRequirements() {
            const visibleItems = document.querySelectorAll('.kanban-item:not([style*="display: none"])');
            return Array.from(visibleItems).map(item => {
                const id = item.dataset.id;
                return moreqRequirements.find(req => req.id === id);
            }).filter(Boolean);
        }

        /**
         * Convierte un array de requisitos a formato CSV.
         * @param {Array<object>} requirements - Lista de requisitos.
         * @param {string} separator - Separador de columnas (coma por defecto).
         * @returns {string} Contenido CSV.
         */
        function convertToCSV(requirements, separator = ',') {
            const headers = [
                'Código MOREQ10',
                'Título del Requisito',
                'Descripción Completa',
                'Servicio MOREQ10',
                'Etapa del Ciclo de Vida',
                'Criticidad General (1-8)',
                'Criterio de Criticidad General',
                'Criticidad para Expedientes',
                'Conformación de Expedientes Relacionados',
                'Tipo de Gestión Requerida',
                'Recomendaciones de Implementación',
                'Estándares ISO Aplicables',
                'Contexto Acuerdo 01/2024'
            ];

            const rows = [headers.join(separator)];

            requirements.forEach(req => {
                const row = [
                    escapeCSV(req.id),
                    escapeCSV(req.title),
                    escapeCSV(req.fullDescription),
                    escapeCSV(req.service),
                    escapeCSV(lifecycleStages[req.stage].title),
                    req.criticality,
                    escapeCSV(criticalityLevels[req.criticality]),
                    escapeCSV(req.criticidadExpediente),
                    escapeCSV(req.componentesExpediente.join('; ')),
                    escapeCSV(req.tipoGestion),
                    escapeCSV(req.recomendaciones.join('; ')),
                    escapeCSV(req.isoStandards.map(iso => `ISO ${iso}`).join('; ')),
                    escapeCSV(`${lifecycleStages[req.stage].description} - Mapeado según Acuerdo 01 de 2024 AGN Colombia`)
                ];
                rows.push(row.join(separator));
            });

            return '\uFEFF' + rows.join('\n'); // Agregar BOM para soporte UTF-8 en Excel
        }

        /**
         * Escapa un valor para ser incluido en un archivo CSV.
         * @param {*} value - El valor a escapar.
         * @returns {string} El valor escapado.
         */
        function escapeCSV(value) {
            if (value === null || value === undefined) return '';
            const stringValue = String(value);
            if (stringValue.includes(',') || stringValue.includes('"') || stringValue.includes('\n') || stringValue.includes('\t')) {
                return `"${stringValue.replace(/"/g, '""')}"`;
            }
            return stringValue;
        }

        /**
         * Descarga un archivo con el contenido y nombre de archivo especificados.
         * @param {string} content - Contenido del archivo.
         * @param {string} filename - Nombre del archivo.
         * @param {string} mimeType - Tipo MIME del archivo.
         */
        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType + ';charset=utf-8;' });
            const link = document.createElement('a');

            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }
        }

        /**
         * Función de utilidad para debouncing.
         * @param {function} func - La función a ejecutar después del retardo.
         * @param {number} wait - El tiempo de espera en milisegundos.
         * @returns {function} La función con debounce.
         */
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Soporte para navegación con teclado
        document.addEventListener('keydown', function(e) {
            const focusedItem = document.activeElement;
            if (!focusedItem || !focusedItem.classList.contains('kanban-item')) return;

            switch(e.key) {
                case 'Enter':
                case ' ':
                    const id = focusedItem.dataset.id;
                    const requirement = moreqRequirements.find(req => req.id === id);
                    if (requirement) {
                        if (hasSpecificExpedienteBinding(requirement)) {
                            showItemDetails(requirement);
                        } else {
                            showSalvedadModal(requirement);
                        }
                    }
                    e.preventDefault();
                    break;
                case 'ArrowDown':
                    const nextItem = focusedItem.nextElementSibling;
                    if (nextItem && nextItem.classList.contains('kanban-item')) {
                        nextItem.focus();
                    }
                    e.preventDefault();
                    break;
                case 'ArrowUp':
                    const prevItem = focusedItem.previousElementSibling;
                    if (prevItem && prevItem.classList.contains('kanban-item')) {
                        prevItem.focus();
                    }
                    e.preventDefault();
                    break;
            }
        });

        /**
         * Función para generar estadísticas del dashboard en una sola pasada.
         * @returns {object} Objeto con las estadísticas del dashboard.
         */
        function generateDashboardStats() {
            const stats = {
                total: moreqRequirements.length,
                byStage: {},
                byService: {},
                byExpediente: {}, // Renombrado para consistencia con el filtro HTML
                byCriticidadExpediente: {},
                byTipoGestion: {},
                conSalvedad: 0,
                sinSalvedad: 0
            };

            const todosExpedientes = []; // Recopilar todos los componentes aquí

            moreqRequirements.forEach(req => {
                // Por Etapa
                stats.byStage[req.stage] = (stats.byStage[req.stage] || 0) + 1;

                // Por Servicio
                stats.byService[req.service] = (stats.byService[req.service] || 0) + 1;

                // Por Criticidad Expediente
                stats.byCriticidadExpediente[req.criticidadExpediente] = (stats.byCriticidadExpediente[req.criticidadExpediente] || 0) + 1;

                // Por Tipo Gestión
                stats.byTipoGestion[req.tipoGestion] = (stats.byTipoGestion[req.tipoGestion] || 0) + 1;

                // Salvedades
                if (hasSpecificExpedienteBinding(req)) {
                    stats.sinSalvedad++;
                } else {
                    stats.conSalvedad++;
                }

                // Recopilar todos los componentes para 'byExpediente'
                todosExpedientes.push(...req.componentesExpediente);
            });

            // Después del bucle principal, procesar byExpediente a partir de los componentes recopilados
            const expedientesUnicos = [...new Set(todosExpedientes)];
            expedientesUnicos.forEach(exp => {
                stats.byExpediente[exp] = todosExpedientes.filter(e => e === exp).length;
            });

            return stats;
        }

        /**
         * Muestra las estadísticas de salvedades en la consola.
         */
        function showSalvedadStats() {
            const stats = generateDashboardStats();
            const porcentajeSalvedad = ((stats.conSalvedad / stats.total) * 100).toFixed(1);

            console.log(`
            📊 ESTADÍSTICAS DE SALVEDADES - Dashboard MOREQ10
            ================================================
            📋 Total de requisitos: ${stats.total}
            ✅ Con vinculación específica: ${stats.sinSalvedad} (${(100 - porcentajeSalvedad)}%)
            ⚠️  Requieren salvedad: ${stats.conSalvedad} (${porcentajeSalvedad}%)

            🎯 Requisitos que requieren documentación de reglas de negocio:
               - Principalmente de servicios del sistema
               - Gestión de usuarios sin contexto documental específico
               - Configuraciones y diagnósticos del sistema
            `);
        }

        // Mensaje de bienvenida en consola
        console.log(`
        🚀 Dashboard MOREQ10 - Componentes de Expedientes para Colombia
        ==============================================================
        ✅ ${moreqRequirements.length} requisitos MOREQ10 cargados
        📋 13 componentes de expedientes mapeados
        🎯 3 niveles de criticidad para expedientes (Alto/Medio/Bajo)

        📊 Funcionalidades avanzadas:
           - Filtrado por componentes de expedientes
           - Mapeo a normativa colombiana (Acuerdo 01/2024)
           - Análisis de tipo de gestión requerida
           - Recomendaciones de implementación específicas
           - Integración con estándares ISO

        🔧 Casos especiales manejados:
           - Requisitos que requieren articulación OGD-TI-Jurídica
           - Componentes no explícitos en MOREQ10
           - Recomendaciones para documentación y normalización
        
        📋 Desarrollado para cumplimiento integral del Acuerdo 01 de 2024 - AGN Colombia
        `);
    </script>
</body>
</html>
